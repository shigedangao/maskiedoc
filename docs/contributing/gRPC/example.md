---
sidebar_position: 3
---

# Implementation example

Each dataset start from a protobuf file. Therefore, for each dataset you may add / update a protobuf. You can follow this [tutorial](https://github.com/hyperium/tonic/blob/master/examples/helloworld-tutorial.md) to quicky understand how to define a new protobuf. If you don't want to follow the tutorial above. Below is a tutorial which will tackle how to add a new protobuf and create a new service based on that protobuf

## Example

In this example. We'll add a gRPC service which will exposes the number of covid cases that has been detected. 

### 1. Define a new protobuf.

In the `proto` folder. Create a file named `case.proto`. In this proto we'll define the service below:

```protobuf
syntax = "proto3";
package case;

service CaseService {
    rpc getCasesByDay(CaseInput) returns (CaseResult);
}

message CaseInput {
    string date = 1;
}

message CaseResult {
    int64 cases = 1;
    string day = 2;
}
```

Now we may add the protobuf in the service. .e.g, the pcr service. 

```rust
// within the build.rs file
tonic_build::configure()
  .build_server(true)
  .build_client(false)
  .compile(
      &[
          "../proto/pcr.proto",
          "../proto/positivity.proto",
          "../proto/case.proto"
      ], 
      &["../proto"]
  )?;
```

To make sure that the proto is valid. We can run the command ```cargo build```. If the build is successful, this means that the proto file is valid.

### 2. Importing the generated proto in the case module

We'll add a new Rust module called `case`. Create the new `case` folder in `pcr/src`. In this new folder add a file called `mod.rs`. Now register the new module in the file `main.rs`. This will makes Rust aware of the new module.

```rust
// main.rs

mod case;
```

Back in the `mod.rs` file. We'll import the case proto modules that has been generated by the `tonic` library. We'll at the same time also declare a new module

```rust
// case/mod.rs
pub mod service;

pub mod proto {
  tonic::include_proto!("case");
}
```

### 3. Code the new service

We now have all the tools to code the new service. Below is the implementation step by step.

1. First, we'll need to create a struct which will hold a handle of the database instance.

```rust
use std::sync::Arc;
use db::{PGPool, query};

pub struct CaseHandle {
    pub pool: Arc<PGPool>
}
```

2. Implementing the protobuf service

In this step we need to implement the protobuf service that we'd defined in the `case.proto`. Below is the code

```rust
use tonic::{Request, Response, Status};
use super::proto::case_service_server::CaseService;
use super::proto::{CaseInput, CaseResult};
use sqlx::{
    postgres::PgRow,
    Row
};
use crate::err::PcrErr;

#[derive(Debug)]
struct Result {
    day: String,
    positive_pcr: Option<f64>
}

impl TryFrom<PgRow> for Result {
  type Error = sqlx::Error;

  fn try_from(value: PgRow) -> Result<Self, Self::Error> {
      let res = Self {
          day: value.try_get("date")?,
          positive_pcr: value.try_get("positive_pcr").ok()
      }

      Ok(res)
  }
}

#[tonic::async_trait]
impl CaseService for CaseHandle {
    async fn get_cases_by_day(
        &self,
        request: Request<CaseInput>
    ) -> Result<Response<CaseResult>, Status> {
        let input = request.into_inner();
        let row = get_case_by_day(request.date).await?;

        match query::get_all_by_date_only::<Result>(
            &self.pool,
            "SELECT * FROM pcr_test_department WHERE jour = $1 AND dep = 75",
            &input.date
        ).await {
            Ok(res) => Ok(Response::new(res)),
            Err(err) => Err(PcrErr::from(err).into())
        }
    }
}

```

### 4. Register the case service to the server

In the main.rs file we need to import the module that we create and an autogenerated module

```diff
// main.rs
+use case::service::CaseHandle;
+use case::proto::case_service_server::CaseServiceServer;


// Update the Server::builder
Server::builder()
    .add_service(health_service)
+   .add_service(CaseServiceServer::new(CaseHandle {
+       pool: Arc::clone(&db_handle)
+   }))
```

### 5. Run the server

Now, the moment of truth. Run the command ```cargo run```. And the server should run. You may use BloomRPC to communicate with the gRPC server
